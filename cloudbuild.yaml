steps:
  - name: 'ubuntu'
    id: 'services-up'
    entrypoint: 'bash'
    args: ['./ci/services-up', 'postgresql']
  - name: 'ubuntu'
    id: 'apt-install'
    entrypoint: 'bash'
    args: ['./ci/apt-install']
    waitFor: ['services-up']
  - name: 'ubuntu'
    id: 'setup-python'
    entrypoint: 'bash'
    args: ['./ci/setup-python', '3.7']
    waitFor: ['apt-install']
  - name: 'ubuntu'
    id: 'pip-install'
    entrypoint: 'bash'
    args: ['./ci/pip-install', 'minimal']
    waitFor: ['setup-python']
  - name: 'ubuntu'
    id: 'prepate-database'
    entrypoint: 'bash'
    args: ['./ci/prepare-database']
    env:
    - 'CI_DATABASE=postgresql'
    - 'CI_DB_PASSWORD=weblate'
    - 'CI_DB_HOST=127.0.0.1'
    - 'CI_DB_PORT=60000'
    - 'CI_SELENIUM=1'
    - 'DJANGO_SETTINGS_MODULE=weblate.settings_test'
    waitFor: ['pip-install']
  - name: 'ubuntu'
    id: 'run-test'
    entrypoint: 'bash'
    args: ['./ci/run-test']
    env:
    - 'CI_DATABASE=postgresql'
    - 'CI_DB_PASSWORD=weblate'
    - 'CI_DB_HOST=127.0.0.1'
    - 'CI_DB_PORT=60000'
    - 'CI_SELENIUM=1'
    - 'DJANGO_SETTINGS_MODULE=weblate.settings_test'
    waitFor: ['prepare-database']
  - name: 'ubuntu'
    id: 'services-down'
    entrypoint: 'bash'
    args: ['./ci/services-down']
    waitFor: ['run-test']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '--file=./mscli-Dockerfile', '--tag=gcr.io/$PROJECT_ID/weblate:$BUILD_ID', '.']
    waitFor: ['services-down']
images: ['gcr.io/$PROJECT_ID/weblate:$BUILD_ID']
tags:
  - Weblate
timeout: 1200s
options:
  machineType: N1_HIGHCPU_8
