# Copyright © Michal Čihař <michal@weblate.org>
#
# SPDX-License-Identifier: GPL-3.0-or-later

name: Rundev

on:
  push:
    branches-ignore:
    - renovate/**
    - weblate
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  rundev:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
        - ubuntu-24.04
        - macos-13
        - windows-2025
    name: Test development Docker
    env:
      PYTHONUNBUFFERED: 1
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        persist-credentials: false
    - uses: douglascamata/setup-docker-macos-action@a9ac5585664f0f68b067ff33c4e993ebd5279425 # v1.0.0
      if: matrix.os == 'macos-13'
    - uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
      with:
        path: /tmp/cache/tesseract
        key: tesseract-data
    - uses: astral-sh/setup-uv@7edac99f961f18b581bbd960d59d049f04c0002f # v6.4.1
    - run: ./rundev.sh build
    - run: ./rundev.sh start
    - run: ./rundev.sh wait
    - run: ./rundev.sh check
    - run: ./rundev.sh compilemessages
    - run: ./rundev.sh test --exitfirst
    - run: ./rundev.sh test weblate/checks/tests/test_chars_checks.py
    - run: ./rundev.sh logs
      if: always()
    - run: ./rundev.sh stop
